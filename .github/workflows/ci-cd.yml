name: Web Calculator CI/CD

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

env:
  DOTNET_VERSION: '8.0.x'
  PROJECT_PATH: 'src/WebCalculator'
  TEST_PATH: 'tests/WebCalculator.Tests'

jobs:
  # –î–∂–æ–±–∞ 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–¥–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
  setup:
    name: üíª –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
    runs-on: ubuntu-latest

    steps:
    - name: üì• –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      uses: actions/checkout@v4

    - name: üìÅ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞
      run: |
        echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≤—Å–µ—Ö —Ñ–∞–π–ª–æ–≤..."
        ls -la
        echo "---"
        ls -la src/WebCalculator/
        echo "---"
        ls -la tests/WebCalculator.Tests/

    - name: ‚öôÔ∏è –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: üì¶ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      run: |
        dotnet restore ${{ env.PROJECT_PATH }}
        dotnet restore ${{ env.TEST_PATH }}

  # –î–∂–æ–±–∞ 2: –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
  build:
    name: üî® –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
    needs: setup  # –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏
    runs-on: ubuntu-latest

    steps:
    - name: üì• –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥
      uses: actions/checkout@v4

    - name: ‚öôÔ∏è –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: üî® –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç
      run: dotnet build ${{ env.PROJECT_PATH }} --configuration Release --no-restore

    - name: üîç –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å–±–æ—Ä–∫–∏
      run: |
        echo "–ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã..."
        ls -la ${{ env.PROJECT_PATH }}/bin/Release/net8.0/

    - name: üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–±—Ä–∞–Ω–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
      uses: actions/upload-artifact@v4
      with:
        name: web-calculator-app
        path: ${{ env.PROJECT_PATH }}/bin/Release/net8.0/
        retention-days: 7

  # –î–∂–æ–±–∞ 3: –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
  test:
    name: ‚úì –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
    needs: build  # –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Å–±–æ—Ä–∫–∏
    runs-on: ubuntu-latest

    steps:
    - name: üì• –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥
      uses: actions/checkout@v4

    - name: ‚öôÔ∏è –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: ‚úì –ó–∞–ø—É—Å–∫–∞–µ–º unit-—Ç–µ—Å—Ç—ã
      run: dotnet test ${{ env.TEST_PATH }} --verbosity normal --logger "trx"

    - name: üìä –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: ${{ env.TEST_PATH }}/TestResults/
        retention-days: 30

  # –î–∂–æ–±–∞ 4: –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–Ω–æ–≥–æ –ø–∞–∫–µ—Ç–∞
  package:
    name: üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–∫–µ—Ç–∞
    needs: test  # –ñ–¥–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è —Ç–µ—Å—Ç–æ–≤
    runs-on: ubuntu-latest

    steps:
    - name: üì• –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥
      uses: actions/checkout@v4

    - name: ‚öôÔ∏è –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}

    - name: üì¶ –ü—É–±–ª–∏–∫—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
      run: dotnet publish ${{ env.PROJECT_PATH }} -c Release -o ./publish --self-contained false

    - name: üìÅ –ê—Ä—Ö–∏–≤–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
      run: |
        zip -r web-calculator-v1.0.0.zip ./publish/*
        echo "–†–∞–∑–º–µ—Ä –∞—Ä—Ö–∏–≤–∞:"
        ls -lh web-calculator-v1.0.0.zip

    - name: üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–ª–∏–∑–Ω—ã–π –ø–∞–∫–µ—Ç
      uses: actions/upload-artifact@v4
      with:
        name: release-package
        path: web-calculator-v1.0.0.zip
        retention-days: 30

  # –î–∂–æ–±–∞ 5: –§–∏–Ω–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç
  report:
    name: üìä –ò—Ç–æ–≥–æ–≤—ã–π –æ—Ç—á–µ—Ç
    needs: [setup, build, test, package]  # –ñ–¥–µ–º –≤—Å–µ –¥–∂–æ–±—ã
    runs-on: ubuntu-latest

    steps:
    - name: üìù –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –æ—Ç—á–µ—Ç
      run: |
        echo "============================================================="
        echo "üìå CI/CD –ü–ê–ô–ü–õ–ê–ù –£–°–ü–ï–®–ù–û –ó–ê–í–ï–†–®–ï–ù! ‚úÖ"
        echo "============================================================="
        echo ""
        echo "    –í–´–ü–û–õ–ù–ï–ù–ù–´–ï –≠–¢–ê–ü–´:"
        echo "    ‚úì –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è"
        echo "    ‚úì –°–±–æ—Ä–∫–∞ –≤–µ–±-–ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è"
        echo "    ‚úì –ó–∞–ø—É—Å–∫ –≤—Å–µ—Ö —Ç–µ—Å—Ç–æ–≤"
        echo "    ‚úì –°–æ–∑–¥–∞–Ω–∏–µ —Ä–µ–ª–∏–∑–Ω–æ–≥–æ –ø–∞–∫–µ—Ç–∞"
        echo ""
        echo "    –°–û–ó–î–ê–ù–ù–´–ï –ê–†–¢–ï–§–ê–ö–¢–´:"
        echo "    ‚óè web-calculator-app - —Å–æ–±—Ä–∞–Ω–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ"
        echo "    ‚óè test-results - —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è"
        echo "    ‚óè release-package - —Ä–µ–ª–∏–∑–Ω—ã–π –ø–∞–∫–µ—Ç"
        echo ""
        echo "    –í—Ä–µ–º—è: $(date)"