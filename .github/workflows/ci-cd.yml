name: Web Calculator CI/CD

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  setup:
    name: üíª –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
    runs-on: ubuntu-latest

    steps:
    - name: üì• –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥ –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
      uses: actions/checkout@v4

    - name: üìÅ –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –ø—Ä–æ–µ–∫—Ç–∞
      run: |
        echo "=== –°–¢–†–£–ö–¢–£–†–ê –ü–†–û–ï–ö–¢–ê ==="
        echo "–¢–µ–∫—É—â–∞—è –ø–∞–ø–∫–∞: $(pwd)"
        echo "---"
        echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∫–æ—Ä–Ω—è:"
        ls -la
        echo "---"
        echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ src:"
        ls -la src/ || echo "–ü–∞–ø–∫–∏ src –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
        echo "---"
        echo "–°–æ–¥–µ—Ä–∂–∏–º–æ–µ tests:"
        ls -la tests/ || echo "–ü–∞–ø–∫–∏ tests –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
        echo "---"
        echo "–ò—â–µ–º .csproj —Ñ–∞–π–ª—ã:"
        find . -name "*.csproj" -type f 2>/dev/null || echo ".csproj —Ñ–∞–π–ª—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã"

    - name: ‚öôÔ∏è –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'

    - name: üì¶ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      run: |
        echo "=== –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –ó–ê–í–ò–°–ò–ú–û–°–¢–ï–ô ==="
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞
        if [ -f "src/WebCalculator/WebCalculator.csproj" ]; then
          echo "–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–µ–∫—Ç..."
          dotnet restore src/WebCalculator/WebCalculator.csproj
        else
          echo "‚ö†Ô∏è –û—Å–Ω–æ–≤–Ω–æ–π –ø—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω: src/WebCalculator/WebCalculator.csproj"
          echo "–ò—â–µ–º –ø—Ä–æ–µ–∫—Ç—ã..."
          find . -name "*.csproj" -type f
          exit 1
        fi
        
        if [ -f "tests/WebCalculator.Tests/WebCalculator.Tests.csproj" ]; then
          echo "–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç..."
          dotnet restore tests/WebCalculator.Tests/WebCalculator.Tests.csproj
        else
          echo "‚ö†Ô∏è –¢–µ—Å—Ç–æ–≤—ã–π –ø—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω: tests/WebCalculator.Tests/WebCalculator.Tests.csproj"
        fi

  build:
    name: üî® –°–±–æ—Ä–∫–∞ –ø—Ä–æ–µ–∫—Ç–∞
    needs: setup
    runs-on: ubuntu-latest

    steps:
    - name: üì• –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥
      uses: actions/checkout@v4

    - name: ‚öôÔ∏è –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'

    - name: üì¶ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      run: |
        echo "–í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏..."
        dotnet restore src/WebCalculator/WebCalculator.csproj

    - name: üî® –°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç
      run: |
        echo "–°–æ–±–∏—Ä–∞–µ–º –ø—Ä–æ–µ–∫—Ç..."
        dotnet build src/WebCalculator/WebCalculator.csproj --configuration Release
        
        echo "=== –ü–†–û–í–ï–†–ö–ê –°–ë–û–†–ö–ò ==="
        echo "–°–æ–±—Ä–∞–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã:"
        if [ -d "src/WebCalculator/bin/Release/net8.0/" ]; then
          ls -la src/WebCalculator/bin/Release/net8.0/
          echo "‚úÖ –°–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–∞!"
        else
          echo "‚ùå –ü–∞–ø–∫–∞ —Å–±–æ—Ä–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
          exit 1
        fi

    - name: üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–±—Ä–∞–Ω–Ω–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: web-calculator-app
        path: src/WebCalculator/bin/Release/net8.0/
        retention-days: 7

  test:
    name: ‚úì –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–æ–≤
    needs: build
    runs-on: ubuntu-latest

    steps:
    - name: üì• –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥
      uses: actions/checkout@v4

    - name: ‚öôÔ∏è –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'

    - name: üì¶ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      run: |
        dotnet restore tests/WebCalculator.Tests/WebCalculator.Tests.csproj

    - name: ‚úì –ó–∞–ø—É—Å–∫–∞–µ–º unit-—Ç–µ—Å—Ç—ã
      run: |
        echo "–ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã..."
        dotnet test tests/WebCalculator.Tests/WebCalculator.Tests.csproj --verbosity normal --logger "trx"
        
        echo "=== –†–ï–ó–£–õ–¨–¢–ê–¢–´ –¢–ï–°–¢–û–í ==="
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤
        if [ -d "tests/WebCalculator.Tests/TestResults" ]; then
          echo "–§–∞–π–ª—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ —Ç–µ—Å—Ç–æ–≤:"
          ls -la tests/WebCalculator.Tests/TestResults/
        fi

    - name: üìä –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã —Ç–µ—Å—Ç–æ–≤
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-results
        path: tests/WebCalculator.Tests/TestResults/
        retention-days: 30

  package:
    name: üì¶ –°–æ–∑–¥–∞–Ω–∏–µ –ø–∞–∫–µ—Ç–∞
    needs: test
    runs-on: ubuntu-latest

    steps:
    - name: üì• –ó–∞–≥—Ä—É–∂–∞–µ–º –∫–æ–¥
      uses: actions/checkout@v4

    - name: ‚öôÔ∏è –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '8.0.x'

    - name: üì¶ –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏
      run: dotnet restore src/WebCalculator/WebCalculator.csproj

    - name: üì¶ –ü—É–±–ª–∏–∫—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
      run: |
        echo "–ü—É–±–ª–∏–∫—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ..."
        dotnet publish src/WebCalculator/WebCalculator.csproj -c Release -o ./publish --self-contained false
        
        echo "=== –°–û–î–ï–†–ñ–ò–ú–û–ï –ü–£–ë–õ–ò–ö–ê–¶–ò–ò ==="
        ls -la ./publish/

    - name: üìÅ –ê—Ä—Ö–∏–≤–∏—Ä—É–µ–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
      run: |
        mkdir -p artifacts
        zip -r artifacts/web-calculator-v1.0.0.zip ./publish/*
        echo "–†–∞–∑–º–µ—Ä –∞—Ä—Ö–∏–≤–∞:"
        ls -lh artifacts/web-calculator-v1.0.0.zip

    - name: üíæ –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ä–µ–ª–∏–∑–Ω—ã–π –ø–∞–∫–µ—Ç
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: release-package
        path: artifacts/web-calculator-v1.0.0.zip
        retention-days: 30